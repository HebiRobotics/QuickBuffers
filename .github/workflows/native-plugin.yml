name: Native Plugin

on:
  push:
    branches: [ release/native-gen ]
  workflow_dispatch:
    inputs:

jobs:
  build-images:
    strategy:
      matrix:
        include:
          - runner: windows-2022
            timeout: 15
          - runner: macos-11
            timeout: 15
          - runner: macos-13-xlarge
            timeout: 10
          - runner: ubuntu-20.04
            timeout: 15
          - runner: [ self-hosted, linux-aarch64 ]
            timeout: 40
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    continue-on-error: false
    steps:
    - uses: actions/checkout@v3
    - uses: stCarolas/setup-maven@v4.5
      with:
        maven-version: 3.9.1
    - uses: graalvm/setup-graalvm@v1
      with:
        version: 'latest'
        java-version: '21'
        set-java-home: 'true'
        native-image-job-reports: 'true'
        cache: '' # disabled to avoid uploading cache of self-hosted runners
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Build native plugins # also builds dependencies to the output
      run: |
        echo "GRAALVM_HOME: $GRAALVM_HOME"
        echo "JAVA_HOME: $JAVA_HOME"
        mvn clean package -P"makeNative,useNative" --projects "protoc-gen-quickbuf,quickbuf-compat" -am

    - name: Upload native plugins
      uses: actions/upload-artifact@v3
      with:
        name: native-plugins
        path: "protoc-gen-*/target/*.exe"
        retention-days: 10

  conveyor-site:
    needs: [build-images]
    runs-on: [self-hosted, Linux]
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK
      uses: actions/setup-java@v1
      with:
        java-version: 8
    - uses: stCarolas/setup-maven@v4.5
      with:
        maven-version: 3.9.1

    - name: Build artifacts # Also tests the Java wrappers
      run: mvn clean package --projects "protoc-gen-quickbuf,quickbuf-compat" -am

    - name: Download pre-built native plugins
      uses: actions/download-artifact@v3
      with:
        name: native-plugins
        path: .

    - name: Conveyor setup
      run: |
        wget https://downloads.hydraulic.dev/conveyor/hydraulic-conveyor_13.0_amd64.deb -O conveyor.deb
        sudo apt install ./conveyor.deb

    - name: Conveyor site
      run: conveyor make site

    - name: Upload site
      uses: actions/upload-artifact@v3
      with:
        name: conveyor-site
        path: output/*
        retention-days: 10
        # TODO: publish to Github releases
      
    - name: Publish artifacts to Maven Central # Tests the native wrapper one more time
      run: mvn package -PuseNative --projects "protoc-gen-quickbuf,quickbuf-compat" -am
      # TODO: setup keys etc.
